```{r, message = FALSE, warning = FALSE, echo = FALSE}
devtools::load_all()
set.seed(42)
```

<!--{pagebreak}-->

## Individual Conditional Expectation (ICE) {#ice}

Plot Individual Conditional Expectation (ICE) menampilkan satu baris per instance yang menunjukkan bagaimana prediksi instance berubah ketika fitur berubah.

Partial dependence plot untuk efek rata-rata dari suatu fitur adalah metode global karena tidak fokus pada contoh tertentu, tetapi pada rata-rata keseluruhan.
Setara dengan PDP untuk instans data individual disebut plot individual conditional expectation (ICE) (Goldstein et al. 2017[^Goldstein2017]).
Plot ICE memvisualisasikan ketergantungan prediksi pada fitur untuk *setiap* instans secara terpisah, menghasilkan satu baris per instans, dibandingkan dengan satu baris keseluruhan dalam partial dependence plot.
PDP adalah rata-rata garis dari plot ICE.
Nilai untuk satu baris (dan satu instans) dapat dihitung dengan menjaga semua fitur lainnya tetap sama, membuat varian instans ini dengan mengganti nilai fitur dengan nilai dari kisi dan membuat prediksi dengan model black box untuk instans yang baru dibuat ini.
Hasilnya adalah satu set poin untuk sebuah instance dengan nilai fitur dari grid dan prediksi masing-masing.

Apa gunanya melihat individual expectations daripada ketergantungan parsial?
Partial dependence plot dapat mengaburkan hubungan heterogen yang diciptakan oleh interaksi.
PDP dapat menunjukkan kepada Anda seperti apa hubungan rata-rata antara fitur dan prediksi.
Ini hanya berfungsi dengan baik jika interaksi antara fitur yang dihitung PDP dan fitur lainnya lemah.
Dalam hal interaksi, plot ICE akan memberikan lebih banyak wawasan.

Definisi yang lebih formal:
Dalam plot ICE, untuk setiap instance dalam $\{(x_{S}^{(i)},x_{C}^{(i)})\}_{i=1}^N$ kurva $\hat {f}_S^{(i)}$ diplot terhadap $x^{(i)}_{S}$, sedangkan $x^{(i)}_{C}$ tetap.

### Examples

Mari kembali ke [set data kanker serviks](#cervical) dan lihat bagaimana prediksi setiap kejadian dikaitkan dengan fitur "Usia".
Kami akan menganalisis random forest yang memprediksi kemungkinan kanker untuk seorang wanita yang diberikan faktor risiko.
Dalam [partial dependence plot](#pdp) kita telah melihat bahwa kemungkinan kanker meningkat sekitar usia 50, tetapi apakah ini benar untuk setiap wanita dalam kumpulan data?
Plot ICE mengungkapkan bahwa bagi kebanyakan wanita, efek usia mengikuti pola rata-rata peningkatan pada usia 50, tetapi ada beberapa pengecualian:
Untuk beberapa wanita yang memiliki kemungkinan prediksi tinggi di usia muda, kemungkinan kanker diprediksi tidak banyak berubah seiring bertambahnya usia.

```{r ice-cervical, fig.cap="ICE plot of cervical cancer probability by age. Each line represents one woman. For most women there is an increase in predicted cancer probability with increasing age. For some women with a predicted cancer probability above 0.4, the prediction does not change much at higher age."}
library("mlr")
library("ggplot2")
data(cervical)
set.seed(43)
cervical_subset_index = sample(1:nrow(cervical), size = 300)
cervical_subset = cervical[cervical_subset_index, ]
cervical.task = makeClassifTask(data = cervical, target = "Biopsy")
mod = mlr::train(mlr::makeLearner(cl = 'classif.randomForest', id = 'cervical-rf', predict.type = 'prob'), cervical.task)
pred.cervical = Predictor$new(mod, cervical_subset, class = "Cancer")
ice = FeatureEffect$new(pred.cervical, "Age", method = "ice")$plot() + 
  scale_color_discrete(guide='none') + 
  scale_y_continuous('Predicted cancer probability')
ice
```

Gambar berikut menunjukkan plot ICE untuk [prediksi sewa sepeda](#bike-data).
Model prediksi yang mendasarinya adalah random forest.

```{r ice-bike, fig.cap='ICE plots of predicted bicycle rentals by weather conditions. The same effects can be observed as in the partial dependence plots.'}
set.seed(42)
data("bike")
bike.subset.index = sample(1:nrow(bike), size = 300)
bike.subset = bike[bike.subset.index,]
bike.task = makeRegrTask(data = bike, target = "cnt")
mod.bike = mlr::train(mlr::makeLearner(cl = 'regr.randomForest', id = 'bike-rf'), bike.task)
pred.bike = Predictor$new(mod.bike, bike.subset)

p1 = FeatureEffect$new(pred.bike, "temp", method = "ice")$plot() + scale_x_continuous("Temperature") + 
  scale_y_continuous("Predicted bicycle rentals")
p2 = FeatureEffect$new(pred.bike, "hum", method = "ice")$plot() + scale_x_continuous("Humidity") + scale_y_continuous("")
p3 = FeatureEffect$new(pred.bike, "windspeed", method = "ice")$plot() + scale_x_continuous("Windspeed")+ scale_y_continuous("")
gridExtra::grid.arrange(p1, p2, p3, ncol = 3)
```

Semua kurva tampaknya mengikuti jalur yang sama, jadi tidak ada interaksi yang jelas.
Itu berarti bahwa PDP sudah merupakan ringkasan yang baik dari hubungan antara fitur yang ditampilkan dan jumlah sepeda yang diprediksi

#### Centered ICE Plot

Ada masalah dengan plot ICE:
Terkadang sulit untuk mengatakan apakah kurva ICE berbeda antar individu karena mereka mulai dari prediksi yang berbeda.
Solusi sederhana adalah memusatkan kurva pada titik tertentu dalam fitur dan hanya menampilkan perbedaan prediksi ke titik ini.
Plot yang dihasilkan disebut plot centered ICE (c-ICE).
Penahan kurva di ujung bawah fitur adalah pilihan yang baik.
Kurva baru didefinisikan sebagai:

$$\hat{f}_{cent}^{(i)}=\hat{f}^{(i)}-\mathbf{1}\hat{f}(x^{a},x^{(i)}_{C})$$

di mana $\mathbf{1}$ adalah vektor 1 dengan jumlah dimensi yang sesuai (biasanya satu atau dua), $\hat{f}$ adalah model yang dipasang dan x^a^ adalah titik jangkar.

#### Example

Misalnya, ambil plot ICE kanker serviks untuk usia dan pusatkan garis pada usia termuda yang diamati:

```{r ice-cervical-centered, fig.cap=sprintf("Centered ICE plot for predicted  cancer probability by age. Lines are fixed to 0 at age %i. Compared to age %i, the predictions for most women remain unchanged until the age of 45 where the predicted probability increases.", min(cervical_subset$Age), min(cervical_subset$Age))}
library("iml")
predictor = Predictor$new(mod, data = cervical_subset, class = "Cancer")
ice = FeatureEffect$new(predictor, feature = "Age", center.at = min(cervical_subset$Age), method = "pdp+ice")
ice$plot()  + scale_color_discrete(guide='none') +
    scale_y_continuous('Cancer probability difference to age 13')
```

Plot ICE yang terpusat memudahkan untuk membandingkan kurva masing-masing instance.
Ini dapat berguna jika kita tidak ingin melihat perubahan absolut dari nilai prediksi, tetapi perbedaan prediksi dibandingkan dengan titik tetap dari rentang fitur.

Mari kita lihat plot centered ICE untuk prediksi sewa sepeda:

```{r ice-bike-centered, fig.cap='Centered ICE plots of predicted number of bikes by weather condition. The lines show the difference in prediction compared to the prediction with the respective feature value at its observed minimum.'}
data(bike)
set.seed(43)
bike.subset.index = sample(1:nrow(bike), size = 100)
bike.subset = bike[bike.subset.index,]

predictor = Predictor$new(mod.bike, data = bike.subset)
ytext1 = sprintf("Different to prediction at temp = %.2f", min(bike$temp))
ice1 = FeatureEffect$new(predictor, feature = "temp", center.at = min(bike$temp), method = "pdp+ice")$plot() +
  scale_y_continuous(ytext1)
ytext2 = sprintf("Different to prediction at hum = %.2f", min(bike$hum))
ice2 = FeatureEffect$new(predictor, feature = "hum", center.at = min(bike$hum), method = "pdp+ice")$plot() +
  scale_y_continuous(ytext2)
ytext3 = sprintf("Different to prediction at windspeed = %.2f", min(bike$windspeed))
ice3 = FeatureEffect$new(predictor, feature = "windspeed", center.at = min(bike$windspeed), method = "pdp+ice")$plot() +
  scale_y_continuous(ytext3)
gridExtra::grid.arrange(ice1, ice2, ice3, nrow = 1)
```

#### Derivative ICE Plot

Cara lain untuk membuatnya lebih mudah secara visual untuk melihat heterogenitas adalah dengan melihat turunan individual dari fungsi prediksi sehubungan dengan fitur.
Plot yang dihasilkan disebut sebagai plot derivative ICE (d-ICE).
Turunan dari suatu fungsi (atau kurva) memberi tahu Anda apakah perubahan terjadi dan ke arah mana perubahan itu terjadi.
Dengan plot derivative ICE, mudah untuk menemukan rentang nilai fitur di mana prediksi black box berubah untuk (setidaknya beberapa) contoh.
Jika tidak ada interaksi antara fitur yang dianalisis $x_S$ dan fitur lainnya $x_C$, maka fungsi prediksi dapat dinyatakan sebagai:

$$\hat{f}(x)=\hat{f}(x_S,x_C)=g(x_S)+h(x_C),\quad\text{with}\quad\frac{\delta\hat{f}(x)}{\delta{}x_S}=g'(x_S)$$

Tanpa interaksi, turunan parsial individu harus sama untuk semua instance.
Jika berbeda, itu karena interaksi dan menjadi terlihat di plot d-ICE.
Selain menampilkan kurva individu untuk turunan dari fungsi prediksi sehubungan dengan fitur di S, menunjukkan standar deviasi dari turunan membantu untuk menyoroti daerah dalam fitur di S dengan heterogenitas dalam turunan yang diperkirakan.
Plot derivative ICE membutuhkan waktu lama untuk dihitung dan agak tidak praktis.


### Advantages

Kurva individual conditional expectation **bahkan lebih intuitif untuk dipahami** daripada partial dependence plot.
Satu baris mewakili prediksi untuk satu contoh jika kita memvariasikan fitur yang diinginkan.

Tidak seperti partial dependence plot, kurva ICE dapat **mengungkap hubungan heterogen**.

### Disadvantages 

Kurva ICE **hanya dapat menampilkan satu fitur** secara bermakna, karena dua fitur akan memerlukan penggambaran beberapa permukaan overlay dan Anda tidak akan melihat apa pun dalam plot.

Kurva ICE mengalami masalah yang sama dengan PDP:
Jika fitur yang diinginkan berkorelasi dengan fitur lainnya, maka **beberapa titik dalam garis mungkin merupakan titik data yang tidak valid** menurut distribusi fitur gabungan.

Jika banyak kurva ICE digambar, **plot bisa menjadi penuh sesak** dan Anda tidak akan melihat apa pun.
Solusinya: Tambahkan sedikit transparansi pada garis atau gambar hanya sampel garis.

Dalam plot ICE mungkin tidak mudah untuk **melihat rata-rata**.
Ini memiliki solusi sederhana:
Gabungkan kurva individual conditional expectation dengan partial dependence plot.

### Software and Alternatives

Plot ICE diimplementasikan dalam paket R `iml` (digunakan untuk contoh ini), `ICEbox`[^ICEbox], dan `pdp`.
Paket R lain yang melakukan sesuatu yang sangat mirip dengan ICE adalah `condvis`. Dalam Python, partial dependence plot dibangun ke dalam scikit-learn dimulai dengan versi 0.24.0.



[^ICEbox]: Goldstein, Alex, et al. "Package ‘ICEbox’." (2017).

[^Goldstein2017]: Goldstein, Alex, et al. "Peeking inside the black box: Visualizing statistical learning with plots of individual conditional expectation." Journal of Computational and Graphical Statistics 24.1 (2015): 44-65.

