```{r, message = FALSE, warning = FALSE, echo = FALSE}
devtools::load_all()
set.seed(42)
```

<!--{pagebreak}-->

## Global Surrogate  {#global}

Surrogate models global adalah model yang dapat ditafsirkan yang dilatih untuk memperkirakan prediksi model black box.
Kita dapat menarik kesimpulan tentang model black box dengan menafsirkan surrogate models.
Memecahkan interpretasi machine learning dengan menggunakan lebih banyak machine learning!


### Theory

Surrogate models juga digunakan dalam rekayasa:
Jika hasil yang diinginkan mahal, memakan waktu atau sulit diukur (misalnya karena berasal dari simulasi komputer yang kompleks), surrogate models yang murah dan cepat dari hasil dapat digunakan.
Perbedaan antara surrogate models yang digunakan dalam teknik dan machine learning yang dapat diinterpretasikan adalah bahwa model yang mendasarinya adalah model machine learning (bukan simulasi) dan bahwa surrogate models harus dapat ditafsirkan.
Tujuan surrogate models (yang dapat ditafsirkan) adalah untuk memperkirakan prediksi model yang mendasarinya seakurat mungkin dan untuk dapat diinterpretasikan pada saat yang sama.
Ide surrogate models dapat ditemukan dengan nama yang berbeda:
Model perkiraan, metamodel, model permukaan respons, emulator, ...

Tentang teori:
Sebenarnya tidak banyak teori yang dibutuhkan untuk memahami surrogate models.
Kami ingin memperkirakan fungsi prediksi black box kami f sedekat mungkin dengan fungsi prediksi surrogate models g, di bawah batasan bahwa g dapat diinterpretasikan.
Untuk fungsi g model apa pun yang dapat ditafsirkan -- misalnya dari [bab model yang dapat ditafsirkan] (#simple) -- dapat digunakan.

Misalnya model linier:

$$g(x)=\beta_0+\beta_1{}x_1{}+\ldots+\beta_p{}x_p$$

Atau decision trees:

$$g(x)=\sum_{m=1}^Mc_m{}I\{x\in{}R_m\}$$

Melatih surrogate models adalah metode model-agnostic, karena tidak memerlukan informasi apa pun tentang cara kerja model black box, hanya akses ke data dan fungsi prediksi yang diperlukan.
Jika model machine learning yang mendasarinya diganti dengan yang lain, Anda masih dapat menggunakan metode pengganti.
Pilihan jenis model black box dan jenis surrogate models dipisahkan.

Lakukan langkah-langkah berikut untuk mendapatkan surrogate models:

1. Pilih kumpulan data X.
Ini bisa berupa kumpulan data yang sama yang digunakan untuk melatih model black box atau kumpulan data baru dari distribusi yang sama.
Anda bahkan dapat memilih subset data atau kisi titik, tergantung pada aplikasi Anda.
1. Untuk dataset X yang dipilih, dapatkan prediksi model black box.
1. Pilih tipe interpretable models (model linier, decision trees, ...).
1. Latih model interpretable pada dataset X dan prediksinya.
1. Selamat! Anda sekarang memiliki surrogate models.
1. Ukur seberapa baik surrogate models mereplikasi prediksi model black box.
1. Menafsirkan surrogate models.

Anda mungkin menemukan pendekatan untuk surrogate models yang memiliki beberapa langkah tambahan atau sedikit berbeda, tetapi ide umumnya biasanya seperti yang dijelaskan di sini.

Salah satu cara untuk mengukur seberapa baik pengganti mereplikasi model black box adalah ukuran R-kuadrat:

$$R^2=1-\frac{SSE}{SST}=1-\frac{\sum_{i=1}^n(\hat{y}_*^{(i)}-\hat{y}^{(i)})^2}{\sum_{i=1}^n(\hat{y}^{(i)}-\bar{\hat{y}})^2}$$

di mana $\hat{y}_*^{(i)}$ adalah prediksi untuk instance ke-i dari surrogate models, $\hat{y}^{(i)}$ prediksi model black box dan $\bar{\hat{y}}$ rata-rata dari prediksi model black box.
SSE adalah singkatan dari sum of squares error dan SST untuk sum of squares total.
Ukuran R-kuadrat dapat diartikan sebagai persentase varians yang ditangkap oleh surrogate models.
Jika R-kuadrat mendekati 1 (= SSE rendah), maka interpretable models mendekati perilaku model black box dengan sangat baik.
Jika interpretable models sangat dekat, Anda mungkin ingin mengganti model yang kompleks dengan interpretable models.
Jika R-kuadrat mendekati 0 (= SSE tinggi), maka model interpretable gagal menjelaskan model black box.

Perhatikan bahwa kita belum berbicara tentang kinerja model dari model black box yang mendasarinya, yaitu seberapa baik atau buruk kinerjanya dalam memprediksi hasil yang sebenarnya.
Kinerja model black box tidak berperan dalam melatih surrogate models.
Interpretasi model surrogate masih valid karena membuat pernyataan tentang model dan bukan tentang dunia nyata.
Namun tentunya interpretasi model surrogate menjadi tidak relevan jika model black box itu buruk, karena dengan begitu model black box itu sendiri tidak relevan.

Kita juga bisa membangun surrogate models berdasarkan subset dari data asli atau reweight instance.
Dengan cara ini, kami mengubah distribusi input surrogate models, yang mengubah fokus interpretasi (maka tidak lagi benar-benar global).
Jika kami menimbang data secara lokal dengan contoh data tertentu (semakin dekat contoh dengan contoh yang dipilih, semakin tinggi bobotnya), kami mendapatkan local surrogate models yang dapat menjelaskan prediksi individu dari contoh tersebut.
Baca lebih lanjut tentang model lokal di [bab berikut](#lime).

### Example

Untuk mendemonstrasikan surrogate models, kami mempertimbangkan regresi dan contoh klasifikasi.

Pertama, kami melatih support vector machine untuk memprediksi [jumlah harian sepeda sewaan](#bike-data) yang diberikan informasi cuaca dan kalender.
Support vector machine tidak terlalu dapat diinterpretasikan, jadi kami melatih pengganti dengan decision trees CART sebagai interpretable models untuk memperkirakan perilaku support vector machine.

```{r surrogate-bike, message = FALSE, warning = FALSE, echo = FALSE, fig.cap = "The terminal nodes of a surrogate tree that approximates the predictions of a support vector machine trained on the bike rental dataset. The distributions in the nodes show that the surrogate tree predicts a higher number of rented bikes when temperature is above 13 degrees Celsius and when the day was later in the 2 year period (cut point at 435 days)."}
library("iml")
data(bike)
bike.task = makeRegrTask(data = bike, target = "cnt")
mod.bike = mlr::train(mlr::makeLearner(cl = 'regr.svm'), bike.task)

pred.bike = Predictor$new(mod.bike, data = bike[, names(bike) != "cnt"])
tree = TreeSurrogate$new(pred.bike) 
plot(tree)


pred.tree  = predict(tree, bike)
pred.svm = getPredictionResponse(predict(mod.bike, bike.task))
```

Surrogate models memiliki R-kuadrat (varians dijelaskan) dari `r round(tree$r.squared, 2)` yang berarti mendekati perilaku black box yang mendasarinya dengan cukup baik, tetapi tidak sempurna.
Jika kecocokannya sempurna, kita dapat membuang support vector machine dan menggunakan pohon sebagai gantinya.

Dalam contoh kedua kami, kami memprediksi probabilitas [kanker serviks](#cervical) dengan random forest.
Sekali lagi kami melatih decision trees dengan dataset asli, tetapi dengan prediksi random forest sebagai hasil, bukan kelas nyata (sehat vs kanker) dari data.

```{r surrogate-cervical, message = FALSE, warning = FALSE, echo = FALSE, fig.cap = "The terminal nodes of a surrogate tree that approximates the predictions of a random forest trained on the cervical cancer dataset. The counts in the nodes show the frequency of the black box models classifications in the nodes."}
data(cervical)
cervical.task = makeClassifTask(data = cervical, target = "Biopsy")
mod.cervical = mlr::train(mlr::makeLearner(cl = 'classif.randomForest', predict.type = "prob"), cervical.task)

pred.cervical = Predictor$new(mod.cervical, data = cervical[names(cervical) != "Biopsy"], type = "prob")
tree.cervical = TreeSurrogate$new(pred.cervical, maxdepth = 2) 
plot(tree.cervical) + 
	theme(strip.text.x = element_text(size = 8))
pred.tree.cervical  = predict(tree.cervical, cervical)["Cancer"]
pred.cervical = getPredictionProbabilities(predict(mod.cervical, cervical.task))
```

Surrogate models memiliki R-kuadrat (varians dijelaskan) dari `r round(tree.cervical$r.squared[1], 2)`, yang berarti tidak mendekati random forest dengan baik dan kita tidak boleh menginterpretasikan pohon secara berlebihan ketika menarik kesimpulan tentang model yang kompleks.

### Advantages 

Metode surrogate models adalah **fleksibel**:
Model apa pun dari [bab model yang dapat ditafsirkan](#simple) dapat digunakan.
Ini juga berarti bahwa Anda tidak hanya dapat bertukar model yang dapat ditafsirkan, tetapi juga model black box yang mendasarinya.
Misalkan Anda membuat beberapa model yang kompleks dan menjelaskannya kepada tim yang berbeda di perusahaan Anda.
Satu tim akrab dengan model linier, tim lain dapat memahami decision trees.
Anda dapat melatih dua surrogate models (model linier dan decision trees) untuk model black box asli dan menawarkan dua jenis penjelasan.
Jika Anda menemukan model black box yang berkinerja lebih baik, Anda tidak perlu mengubah metode interpretasi Anda, karena Anda dapat menggunakan kelas surrogate models yang sama.

Saya berpendapat bahwa pendekatannya sangat **intuitif** dan lugas.
Ini berarti mudah diterapkan, tetapi juga mudah dijelaskan kepada orang yang tidak terbiasa dengan ilmu data atau machine learning.

Dengan **ukuran R-kuadrat**, kita dapat dengan mudah mengukur seberapa baik surrogate models kita dalam mendekati prediksi black box.

### Disadvantages

Anda harus sadar bahwa Anda menarik **kesimpulan tentang model dan bukan tentang data**, karena surrogate models tidak pernah melihat hasil yang sebenarnya.

Tidak jelas apa yang terbaik **cut-off untuk R-kuadrat** untuk yakin bahwa surrogate models cukup dekat dengan model black box.
80% dari varians dijelaskan? 50%? 99%?

Kita dapat mengukur seberapa dekat model surrogate dengan model black box.
Mari kita asumsikan kita tidak terlalu dekat, tetapi cukup dekat.
Bisa terjadi bahwa interpretable models sangat **dekat untuk satu subset dari dataset, tetapi sangat berbeda untuk subset lain**.
Dalam hal ini interpretasi untuk model sederhana tidak akan sama baiknya untuk semua titik data.

Model interpretable yang Anda pilih sebagai pengganti **dilengkapi dengan segala kelebihan dan kekurangannya**.

Beberapa orang berpendapat bahwa, secara umum, **tidak ada interpretable models secara intrinsik** (termasuk bahkan model linier dan decision trees) dan bahkan akan berbahaya untuk memiliki ilusi interpretasi.
Jika Anda berbagi pendapat ini, maka tentu saja metode ini bukan untuk Anda.

### Software

Saya menggunakan paket `iml` R sebagai contoh.
Jika Anda dapat melatih model machine learning, maka Anda harus dapat menerapkan surrogate models sendiri.
Cukup latih model yang dapat ditafsirkan untuk memprediksi prediksi model black box.

